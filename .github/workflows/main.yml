name: High Frequency Monitor (Loop)

on:
  schedule:
    - cron: '*/5 * * * *' # GitHub é™åˆ¶æœ€å°5åˆ†é’Ÿ
  workflow_dispatch:      # å…è®¸æ‰‹åŠ¨è§¦å‘

jobs:
  high_freq_scrape:
    runs-on: ubuntu-latest
    
    # ğŸ‘‡ å¿…é¡»ç»™å†™æƒé™ï¼Œå¦åˆ™æ— æ³•æäº¤ä»£ç å’Œåˆ é™¤æ—¥å¿—
    permissions:
      contents: write
      actions: write

    steps:
      - name: Checkout Code
        uses: actions/checkout@v3

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'

      - name: Install Dependencies
        run: npm install puppeteer-core

      - name: Setup Git Config
        run: |
          git config --global user.name 'github-actions[bot]'
          git config --global user.email 'github-actions[bot]@users.noreply.github.com'

      # ==========================================================
      # ğŸ”¥ æ ¸å¿ƒé€»è¾‘ï¼šå¾ªç¯è¿è¡Œ 3 æ¬¡
      # 0s (Run 1) -> 100s (Run 2) -> 200s (Run 3)
      # ==========================================================
      - name: Loop Scrape 3 Times
        run: |
          for i in {1..3}; do
            echo "ğŸš€ Starting Run #$i..."
            
            # 1. è¿è¡Œçˆ¬è™«
            node scrape.js
            
            # 2. æäº¤ä»£ç  (å¦‚æœæœ‰å˜åŒ–)
            git add data.json
            git commit -m "Auto update (Run $i)" || echo "No changes to commit"
            git push
            
            # 3. å¦‚æœä¸æ˜¯æœ€åä¸€æ¬¡ï¼Œå°±ä¼‘æ¯ 100 ç§’ (çº¦1åˆ†åŠ)
            if [ $i -lt 3 ]; then
              echo "ğŸ’¤ Sleeping for 100 seconds..."
              sleep 100
            fi
          done

      # ==========================================================
      # ğŸ§¹ æ¸…ç†æ—§è®°å½•ï¼šé˜²æ­¢ Actions é¡µé¢è¢«åˆ·å±
      # ==========================================================
      - name: Delete Old Pages Builds
        if: always() # æ— è®ºå‰é¢æ˜¯å¦æˆåŠŸï¼Œéƒ½å°è¯•æ¸…ç†
        uses: Mattraks/delete-workflow-runs@v2
        with:
          token: ${{ github.token }}
          repository: ${{ github.repository }}
          retain_days: 0
          keep_minimum_runs: 0
          delete_workflow_pattern: "pages build and deployment"
