name: Realtime Monitor (Loop + Gist)

on:
  schedule:
    - cron: '*/5 * * * *'
  workflow_dispatch:

jobs:
  scrape_loop:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Setup Node
        uses: actions/setup-node@v3
        with:
          node-version: '18'

      - name: Install Deps
        run: npm install puppeteer-core

      # ==========================================================
      # ğŸ”„ å¾ªç¯ 3 æ¬¡ï¼Œæ¯æ¬¡éƒ½æŠŠæœ€æ–°çš„æ•°æ®æ¨é€åˆ° Gist
      # ==========================================================
      - name: Loop Scrape (Update Gist)
        # ğŸ‘‡ å…³é”®ï¼šæŠŠ Secrets ä¼ ç»™è„šæœ¬
        env:
          GH_TOKEN: ${{ secrets.GH_TOKEN }}
          GIST_ID: ${{ secrets.GIST_ID }}
        run: |
          for i in {1..3}; do
            echo "----------------------------------------"
            echo "ğŸš€ Run #$i Start"
            
            # è¿è¡Œè„šæœ¬ (è„šæœ¬é‡Œä¼šè‡ªåŠ¨ä¸Šä¼  Gist)
            node scrape.js
            
            # ä¼‘æ¯ 80 ç§’ (ç•™å‡ºæ—¶é—´ç»™ä¸‹ä¸€æ¬¡)
            if [ $i -lt 3 ]; then
              echo "ğŸ’¤ Sleeping 80s..."
              sleep 80
            fi
          done

      # ==========================================================
      # ğŸ§¹ æ¸…ç†æ—¥å¿— (ä¿æŒåå°å¹²å‡€)
      # ==========================================================
      - name: Cleanup Logs
        if: always()
        uses: Mattraks/delete-workflow-runs@v2
        with:
          token: ${{ github.token }}
          repository: ${{ github.repository }}
          retain_days: 0
          keep_minimum_runs: 0
          delete_workflow_pattern: "pages build and deployment"
