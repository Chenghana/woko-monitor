name: 2-Minute Update (Clean & Auto-Delete)

on:
  schedule:
    - cron: '*/5 * * * *' # 5åˆ†é’Ÿå”¤é†’ä¸€æ¬¡
  workflow_dispatch:      # å…è®¸æ‰‹åŠ¨è¿è¡Œ

jobs:
  scrape_and_commit:
    runs-on: ubuntu-latest
    
    # ğŸ‘‡ å…³é”®ä¿®æ”¹ï¼šæ·»åŠ  actions: write æƒé™ï¼Œå¦åˆ™æ— æ³•åˆ é™¤è®°å½•
    permissions:
      contents: write
      actions: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'

      - name: Install Dependencies
        run: npm install puppeteer-core

      # =================================================
      # ğŸƒâ€â™‚ï¸ ç¬¬ä¸€è½®æŠ“å– (0åˆ†0ç§’)
      # =================================================
      - name: Run Scraper (Round 1)
        run: node scrape.js

      - name: Commit and Push (Round 1)
        run: |
          git config --global user.name 'github-actions[bot]'
          git config --global user.email 'github-actions[bot]@users.noreply.github.com'
          git add data.json
          git commit -m "Auto update data (Round 1)" || echo "No changes to commit"
          git push

      # =================================================
      # â³ åŸåœ°ä¼‘æ¯ 130 ç§’ (å®ç°2åˆ†é’Ÿé—´éš”)
      # =================================================
      - name: Sleep for 130 seconds
        run: sleep 130

      # =================================================
      # ğŸƒâ€â™‚ï¸ ç¬¬äºŒè½®æŠ“å– (2åˆ†10ç§’)
      # =================================================
      - name: Run Scraper (Round 2)
        run: node scrape.js

      - name: Commit and Push (Round 2)
        run: |
          git add data.json
          git commit -m "Auto update data (Round 2)" || echo "No changes to commit"
          git push

      # =================================================
      # ğŸ—‘ï¸ æ–°å¢ï¼šå¦‚æœæˆåŠŸï¼Œè‡ªåŠ¨åˆ é™¤æ—§çš„ Pages æ„å»ºè®°å½•
      # =================================================
      - name: Delete Old Pages Builds
        uses: Mattraks/delete-workflow-runs@v2
        with:
          token: ${{ github.token }}
          repository: ${{ github.repository }}
          retain_days: 0
          keep_minimum_runs: 0 # ä¸ä¿ç•™ä»»ä½•æ—§è®°å½•ï¼Œåªçœ‹æœ€æ–°çš„
          delete_workflow_pattern: "pages build and deployment" # ç²¾å‡†åŒ¹é… Pages çš„å·¥ä½œæµåç§°
