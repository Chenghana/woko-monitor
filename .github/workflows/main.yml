name: 2-Minute Update (Force Clean)

on:
  schedule:
    - cron: '*/5 * * * *'
  workflow_dispatch:

jobs:
  scrape_and_commit:
    runs-on: ubuntu-latest
    
    # ğŸ‘‡ æƒé™å¿…é¡»ç»™è¶³ï¼Œå¦åˆ™åˆ ä¸æ‰
    permissions:
      contents: write
      actions: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'

      - name: Install Dependencies
        run: npm install puppeteer-core

      - name: Setup Git
        run: |
          git config --global user.name 'github-actions[bot]'
          git config --global user.email 'github-actions[bot]@users.noreply.github.com'

      # =================================================
      # ğŸƒâ€â™‚ï¸ å¾ªç¯æŠ“å– (è¿™é‡Œä¿æŒä¸å˜)
      # =================================================
      - name: Loop Scrape 3 Times
        run: |
          for i in {1..3}; do
            echo "ğŸš€ Run #$i..."
            node scrape.js
            git add data.json
            git commit -m "Auto update (Run $i)" || echo "No changes"
            git push
            if [ $i -lt 3 ]; then
              echo "ğŸ’¤ Sleep 100s..."
              sleep 100
            fi
          done

      # =================================================
      # ğŸ—‘ï¸ å¼ºåŠ›æ¸…ç†æ—§è®°å½• (é‡ç‚¹ä¿®æ”¹äº†è¿™é‡Œ)
      # =================================================
      - name: Delete Old Workflow Runs
        # ğŸ‘‡ å…³é”®ï¼šä¸ç®¡å‰é¢æ˜¯å¦æŠ¥é”™ï¼Œè¿™ä¸€æ­¥å¿…é¡»æ‰§è¡Œï¼
        if: always() 
        uses: Mattraks/delete-workflow-runs@v2
        with:
          token: ${{ github.token }}
          repository: ${{ github.repository }}
          retain_days: 0
          keep_minimum_runs: 0
          # ğŸ‘‡ åŒæ—¶åˆ é™¤ "2-Minute Update..." è‡ªå·±å’Œ "pages..." æ„å»ºè®°å½•
          delete_workflow_pattern: "pages build and deployment"
